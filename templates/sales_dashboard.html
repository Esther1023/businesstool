<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”€å”®å·¥ä½œå°</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      /* é”€å”®è§†å›¾ï¼šæ›´ç®€æ´çš„å¸ƒå±€ä¸æ›´å¤§çš„è§¦æ§ç›®æ ‡ */
      .sales-container { max-width: 1100px; margin: 20px auto; padding: 10px; }
      .sales-header { display:flex; justify-content: space-between; align-items:center; }
      .sales-header h2 { margin:0; color: var(--text-color); }
      .monitor-controls { display:flex; gap:8px; }
      /* ä»…ä½œç”¨äºé¡¶éƒ¨å¸ƒå±€åˆ‡æ¢æŒ‰é’®ï¼Œæå‡å¯¹æ¯”åº¦ */
      .monitor-controls .btn { padding:8px 12px; border:none; border-radius:10px; cursor:pointer; background-image: var(--gradient-primary); background-color: var(--primary-color); color:#2f3b47; box-shadow:0 6px 18px var(--shadow-color); }
      .monitor-controls .btn:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
      .btn-secondary { background: var(--secondary-color); }
      .assist-calendar { margin-top:16px; }
      /* åªä¿ç•™å¿…éœ€å…ƒç´ çš„åŸºæœ¬æ ·å¼ */
    </style>
</head>
<body class="show-scrollbars">
  <div class="sales-container">
    <div class="sales-header">
      <div class="monitor-controls">
        <button id="btnLayoutComfortable" class="btn">æ ‡å‡†</button>
        <button id="btnLayoutCompact" class="btn">ç´§å‡‘</button>
      </div>
    </div>

    <!-- åˆåŒä¸æŠ¥ä»·æ¨¡å—ï¼šä¿ç•™ç”ŸæˆåˆåŒã€æŠ¥ä»·å•ã€æµ‹è¯•æ•°æ® -->
    <div class="card" style="margin-top:12px;">
      <form id="contractForm" enctype="multipart/form-data" method="post" action="/generate">
        <div class="form-group">
          <label for="fileInput">å¿«é€Ÿé€‰æ‹©æ¨¡æ¿</label>
          <div class="template-buttons">
            <button type="button" class="btn btn-template" data-template="æ ‡å‡†ç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">æ ‡å‡†ç‰ˆ</button>
            <button type="button" class="btn btn-template" data-template="ä¼ä¸šç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">ä¼ä¸šç‰ˆ</button>
            <button type="button" class="btn btn-template" data-template="å®šåˆ¶ç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">å®šåˆ¶ç‰ˆ</button>
            <button type="button" class="btn btn-template" data-template="é’æ˜¥ç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">é’æ˜¥ç‰ˆ</button>
            <button type="button" class="btn btn-template" data-template="ä¸“ä¸šç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">ä¸“ä¸šç‰ˆ</button>
          </div>
        </div>
        <input type="file" name="template" accept=".docx" required class="file-input" id="fileInput" style="display:none;">

        <!-- åŸºæœ¬ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
        <div class="form-section">
          <h3>ç”²æ–¹åŸºæœ¬ä¿¡æ¯</h3>
          <div class="variables-form">
            <div class="form-group">
              <label for="company_name">å…¬å¸åç§° <span class="required-star">*</span></label>
              <input type="text" class="form-control" name="company_name" id="company_name" required placeholder="è¾“å…¥å…¬å¸åç§°">
              <div class="error-text" id="error_company_name" style="display:none"></div>
            </div>
            <div class="form-group">
              <label for="tax_number">ç¨å· <span class="required-star">*</span></label>
              <input type="text" class="form-control" name="tax_number" id="tax_number" required>
              <div class="error-text" id="error_tax_number" style="display:none"></div>
            </div>
            <div class="form-group">
              <label for="jdy_account">ç®€é“äº‘è´¦å· <span class="required-star">*</span></label>
              <div class="input-group">
                <input type="text" class="form-control" name="jdy_account" id="jdy_account" required oninput="debounceQueryCustomerSales(event)" placeholder="è¾“å…¥IDæ˜¾ç¤ºå…¨éƒ¨ä¿¡æ¯">
                <input type="file" id="excelUpload" accept=".xlsx" style="display:none">
                <button type="button" class="btn btn-excel" onclick="document.getElementById('excelUpload').click()">å¯¼å…¥Excel</button>
                <button type="button" class="btn btn-shortcut" id="btn-sa-inline">ç®€é“çœ¼</button>
                <button type="button" class="btn btn-shortcut" id="btn-huikuan-inline">çœ‹çœ‹é’±</button>
                <button type="button" class="btn btn-shortcut" id="btn-daike-inline">biçœ‹æ¿</button>
                <span id="lastImportTime" class="assist-help"></span>
              </div>
              <div class="error-text" id="error_jdy_account" style="display:none"></div>
            </div>

            <!-- å°† OCR ä¸å‰ªè´´æ¿åŒºåŸŸç§»åŠ¨åˆ°ç”²æ–¹åŸºæœ¬ä¿¡æ¯ï¼Œå¤åˆ¶é¦–é¡µUIæ ·å¼ä¸å¤§å° -->
            <div class="form-group full-width">
              <div class="smart-fill-container">
                <!-- å·¦ä¾§ï¼šOCRè¯†åˆ«åŒºåŸŸ -->
                <div class="ocr-section">
                  <div class="image-upload-container">
                    <div class="image-upload-area" id="imageUploadArea">
                      <div class="upload-content">
                        <div class="upload-icon">ğŸ“·</div>
                        <div class="upload-text">
                          <p>æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                          <p class="upload-hint">æ”¯æŒ PNGã€JPGã€JPEG ç­‰æ ¼å¼</p>
                          <p class="upload-hint">ä¹Ÿå¯ä»¥ç›´æ¥ç²˜è´´æˆªå›¾ï¼ˆCtrl+Vï¼‰</p>
                          <p class="upload-hint">ä¸Šä¼ åè‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……è¡¨å•</p>
                        </div>
                      </div>
                      <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                    </div>
                    <div class="image-preview" id="imagePreview" style="display: none;">
                      <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
                      <div class="preview-actions">
                        <button type="button" class="btn btn-secondary" id="clearImageBtn">æ¸…é™¤å›¾ç‰‡</button>
                      </div>
                    </div>
                    <div class="ocr-progress" id="ocrProgress" style="display: none;">
                      <div class="progress-bar"><div class="progress-fill"></div></div>
                      <p class="progress-text">æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—å¹¶è‡ªåŠ¨å¡«å……...</p>
                    </div>
                  </div>
                </div>
                <!-- å³ä¾§ï¼šç²˜è´´æ¿è‡ªåŠ¨å¡«å……åŒºåŸŸ -->
                <div class="clipboard-section">
                  <div class="clipboard-container">
                    <div class="clipboard-area" id="clipboardArea">
                      <div class="clipboard-content">
                        <div class="clipboard-icon">ğŸ“‹</div>
                        <div class="clipboard-text">
                          <p>æ™ºèƒ½ç²˜è´´è¯†åˆ«</p>
                          <p class="clipboard-hint">åœ¨é¡µé¢ä»»æ„ä½ç½®ç²˜è´´æ–‡æœ¬</p>
                          <p class="clipboard-hint">ç³»ç»Ÿå°†è‡ªåŠ¨è§£æå¹¶å¡«å……è¡¨å•</p>
                        </div>
                      </div>
                      <textarea id="clipboardTextarea" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬å†…å®¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……ç›¸å…³å­—æ®µ..." rows="8"></textarea>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- æœåŠ¡æœŸé™ä¸è´¹ç”¨ä¿¡æ¯ï¼ˆä¿ç•™è®¡ç®—ä¸æŒ‰é’®ï¼‰ -->
        <div class="form-section">
          <h3>æœåŠ¡æœŸé™ä¸è´¹ç”¨ä¿¡æ¯</h3>
          <div class="variables-form">
            <div class="form-subsection">
              <div class="subsection-fields">
                <div class="form-group service-duration-group">
                  <label>æœåŠ¡æœŸé™ï¼ˆå¿…å¡«ï¼‰</label>
                  <div class="duration-inputs">
                    <div class="duration-input-item">
                      <label for="serviceYears">å¹´ä»½</label>
                      <input type="number" class="form-control" name="service_years" required min="0" id="serviceYears" placeholder="0">
                    </div>
                    <div class="duration-input-item">
                      <label for="serviceMonths">é¢å¤–æœˆä»½</label>
                      <input type="number" class="form-control" name="service_months" min="0" max="23" id="serviceMonths" placeholder="0">
                    </div>
                  </div>
                  <div class="duration-summary" id="durationSummary">æ€»è®¡ï¼š0å¹´0ä¸ªæœˆ</div>
                </div>
                <div class="form-group"><label for="startYear">å¼€å§‹å¹´ä»½ï¼ˆå¿…å¡«ï¼‰</label><input type="number" class="form-control" name="start_year" required id="startYear"></div>
                <div class="form-group"><label for="startMonth">å¼€å§‹æœˆä»½ï¼ˆå¿…å¡«ï¼‰</label><input type="number" class="form-control" name="start_month" min="1" max="12" required id="startMonth"></div>
                <div class="form-group"><label for="startDay">å¼€å§‹æ—¥æœŸï¼ˆå¿…å¡«ï¼‰</label><input type="number" class="form-control" name="start_day" min="1" max="31" required id="startDay"></div>
                <div class="form-group"><label for="endYear">ç»“æŸå¹´ä»½ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label><input type="number" class="form-control" name="end_year" required readonly id="endYear"></div>
                <div class="form-group"><label for="endMonth">ç»“æŸæœˆä»½ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label><input type="number" class="form-control" name="end_month" min="1" max="12" required readonly id="endMonth"></div>
                <div class="form-group"><label for="endDay">ç»“æŸæ—¥æœŸï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label><input type="number" class="form-control" name="end_day" min="1" max="31" required readonly id="endDay"></div>
              </div>
            </div>

            <div class="form-subsection">
              <div class="subsection-fields">
                <div class="form-group">
                  <label for="totalAmount">æœåŠ¡è´¹ç”¨é‡‘é¢ï¼ˆæ•°å­—ï¼‰ <span class="required-star">*</span></label>
                  <input type="number" class="form-control" name="total_amount" required id="totalAmount" step="0.01" min="0" oninput="calculateUnitPrice()">
                  <div class="error-text" id="error_total_amount" style="display:none"></div>
                </div>
                <div class="form-group">
                  <label for="user_count">ä½¿ç”¨äººæ•° <span class="required-star">*</span></label>
                  <input type="number" class="form-control" name="user_count" id="user_count" required min="1" step="1" oninput="calculateUnitPrice()">
                  <div class="error-text" id="error_user_count" style="display:none"></div>
                </div>
                <div class="form-group">
                  <label for="unitPrice">å•ä»·ï¼ˆå…ƒ/äºº/å¹´ï¼‰</label>
                  <input type="number" class="form-control" name="unit_price" required id="unitPrice" step="0.01" min="0" oninput="calculateTotalAmount()">
                </div>
                <div class="form-group full-width">
                  <label for="totalAmountCn">æœåŠ¡è´¹ç”¨é‡‘é¢ï¼ˆå¤§å†™ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                  <div class="amount-with-buttons">
                    <input type="text" class="form-control" name="total_amount_cn" required readonly id="totalAmountCn">
                    <div class="inline-buttons">
                      <button type="button" class="btn btn-secondary action-btn" onclick="fillTestData()">å¡«å……æµ‹è¯•æ•°æ®</button>
                      <button type="button" class="btn btn-quote action-btn" onclick="generateQuote()">ç”ŸæˆæŠ¥ä»·å•</button>
                      <button type="submit" class="btn btn-primary action-btn">ç”ŸæˆåˆåŒ</button>
                    </div>
                  </div>
                </div>
                <input type="hidden" name="payment_amount" id="paymentAmount">
                <input type="hidden" name="payment_amount_cn" id="paymentAmountCn">
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>

    <!-- è·Ÿè¿›æ—¥è®°æ¨¡å—å·²ç§»å…¥æ‚¬æµ®çœ‹æ¿ -->

    <!-- Excelå¯¼å…¥æ¨¡å—ç§»é™¤ï¼Œå·²é›†æˆåˆ°â€œç®€é“äº‘è´¦å·â€åé¢ -->

    <!-- OCRä¸å‰ªè´´æ¿æ¨¡å—ç§»é™¤ï¼Œå·²ç§»åŠ¨åˆ°ç”²æ–¹åŸºæœ¬ä¿¡æ¯ä¸­ -->

    <!-- å…¼å®¹è„šæœ¬çš„æ‚¬æµ®çƒä¸é¢æ¿ï¼ˆç®€åŒ–ç‰ˆï¼‰ -->
    <div id="assistBall" class="assist-ball" title="å¿«æ·æ“ä½œï¼ˆCtrl/âŒ˜ + Shift + Kï¼‰">âš¡</div>
    <div id="assistPanel" class="assist-panel" aria-hidden="true">
      <div class="assist-panel-body">
        <button id="assistClose" class="btn btn-secondary">å…³é—­</button>
        <input id="assistId" class="assist-input" placeholder="ç®€é“äº‘è´¦å·">
        <textarea id="assistMemo" class="memo-textarea" placeholder="å¤‡æ³¨"></textarea>
        <div style="display:flex; gap:6px; margin:8px 0;">
          <button id="btnStageContract" class="btn">åˆåŒ</button>
          <button id="btnStageInvoice" class="btn">å¼€ç¥¨</button>
          <button id="btnStageAdvanceInvoice" class="btn">æå‰å¼€</button>
          <button id="btnStageInvalid" class="btn">æ— æ•ˆ</button>
          <button id="btnStageUpsell" class="btn">å¢è´­</button>
          <button id="btnStageLost" class="btn">å¤±è”</button>
          <button id="btnStagePaid" class="btn">å›æ¬¾</button>
        </div>
        <div id="assistAnswer" class="assist-help">æç¤ºï¼šé”€å”®çœ‹æ¿ä¸“ç”¨è§†å›¾</div>
        <!-- å°†è·Ÿè¿›æ—¥è®°åŠŸèƒ½åµŒå…¥æ‚¬æµ®é¢æ¿ -->
        <div class="assist-subsection" style="margin-top:10px; border-top:1px solid var(--border-color); padding-top:10px;">
          <div class="assist-section-title" style="font-weight:600; color: var(--text-color);">è·Ÿè¿›æ—¥è®°</div>
          <div class="form-group"><input id="diaryJdy" class="form-control" placeholder="ç®€é“äº‘è´¦å·ï¼Œå¦‚ï¼š123456abcdef" required></div>
          <div class="form-group"><input id="diaryCompany" class="form-control" placeholder="å…¬å¸åç§°ï¼ˆå¯é€‰ï¼‰"></div>
          <div class="form-group"><textarea id="diaryNote" class="form-control" rows="3" placeholder="ä»Šå¤©å’Œå®¢æˆ·æ²Ÿé€šäº†ä»€ä¹ˆ..." required></textarea></div>
          <div class="form-group" style="display:flex; gap:8px; align-items:center;">
            <button id="btnAddDiary" class="btn btn-secondary">æ·»åŠ è®°å½•</button>
            <button id="btnQueryDiary" class="btn">æŸ¥è¯¢å†å²è®°å½•</button>
            <span id="diaryCount" class="assist-help"></span>
          </div>
          <div id="diaryList" class="unsigned-list" style="max-height:180px; overflow:auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/script.js"></script>
  <script>
    // â€”â€” è‡ªåŠ¨å¡«å……ä¸è‡ªåŠ¨è®¡ç®—ï¼šç§»æ¤é¦–é¡µå®Œæ•´é€»è¾‘ â€”â€”
    function numberToChinese(num) {
      if (num === 0) { return 'é›¶åœ†æ•´'; }
      const chineseNums = ['é›¶','å£¹','è´°','å','è‚†','ä¼','é™†','æŸ’','æŒ','ç–'];
      const units = ['', 'æ‹¾', 'ä½°', 'ä»Ÿ'];
      const bigUnits = ['', 'ä¸‡', 'äº¿'];
      num = Math.floor(num);
      let strArr = []; let current = num; let level = 0;
      while (current > 0) {
        let section = current % 10000; let sectionStr = ''; let hasValue = false; let lastHasValue = false;
        for (let i = 0; i < 4; i++) {
          const digit = section % 10;
          if (digit === 0) { if (lastHasValue && section > 0) { sectionStr = 'é›¶' + sectionStr; } lastHasValue = false; }
          else { sectionStr = chineseNums[digit] + units[i] + sectionStr; hasValue = true; lastHasValue = true; }
          section = Math.floor(section / 10);
        }
        if (hasValue) { sectionStr = sectionStr + bigUnits[level] + (strArr.length > 0 ? 'é›¶' : ''); }
        if (sectionStr) { strArr.unshift(sectionStr.replace(/é›¶+$/, '').replace(/é›¶+/g, 'é›¶')); }
        current = Math.floor(current / 10000); level++;
      }
      let result = strArr.join('').replace(/é›¶+$/, '');
      return result + 'åœ†æ•´';
    }

    function updateChineseAmount(value) {
      const num = parseFloat(value) || 0;
      const cn = numberToChinese(num);
      const totalCn = document.getElementById('totalAmountCn'); if (totalCn) totalCn.value = cn;
      const pay = document.getElementById('paymentAmount'); if (pay) pay.value = num;
      const payCn = document.getElementById('paymentAmountCn'); if (payCn) payCn.value = cn;
    }

    function roundToTwo(num) { return Math.round((num + Number.EPSILON) * 100) / 100; }

    function getTotalServiceYears() {
      const years = parseInt(document.getElementById('serviceYears').value) || 0;
      const months = parseInt(document.getElementById('serviceMonths').value) || 0;
      return years + (months / 12);
    }

    function calculateUnitPrice() {
      const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
      const userCount = parseFloat(document.querySelector('[name="user_count"]').value) || 0;
      const rawYears = getTotalServiceYears();
      const serviceYears = rawYears > 0 ? rawYears : 1; // æœªå¡«å†™å¹´é™æ—¶é»˜è®¤æŒ‰1å¹´è®¡ç®—
      if (totalAmount && userCount) {
        const unitPrice = totalAmount / (userCount * serviceYears);
        const roundedUnitPrice = roundToTwo(unitPrice);
        document.getElementById('unitPrice').value = roundedUnitPrice.toFixed(2);
        updateChineseAmount(totalAmount);
      }
    }

    function calculateTotalAmount() {
      const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
      const userCount = parseFloat(document.querySelector('[name="user_count"]').value) || 0;
      const rawYears = getTotalServiceYears();
      const serviceYears = rawYears > 0 ? rawYears : 1; // ä¸å•ä»·è®¡ç®—ä¿æŒä¸€è‡´
      if (unitPrice && userCount) {
        const totalAmount = unitPrice * userCount * serviceYears;
        const roundedTotalAmount = roundToTwo(totalAmount);
        document.getElementById('totalAmount').value = roundedTotalAmount.toFixed(2);
        updateChineseAmount(roundedTotalAmount);
      }
    }

    function calculateEndDate() {
      const years = parseInt(document.getElementById('serviceYears').value) || 0;
      const months = parseInt(document.getElementById('serviceMonths').value) || 0;
      const startYear = parseInt(document.getElementById('startYear').value) || 0;
      const startMonth = parseInt(document.getElementById('startMonth').value) || 0;
      const startDay = parseInt(document.getElementById('startDay').value) || 0;
      if ((years > 0 || months > 0) && startYear && startMonth && startDay) {
        const endYear = document.getElementById('endYear');
        const endMonth = document.getElementById('endMonth');
        const endDay = document.getElementById('endDay');
        if (!endYear || !endMonth || !endDay) return;
        const startDate = new Date(startYear, startMonth - 1, startDay);
        const endDate = new Date(startDate);
        endDate.setFullYear(endDate.getFullYear() + years);
        endDate.setMonth(endDate.getMonth() + months);
        endDate.setDate(endDate.getDate() - 1);
        endYear.value = endDate.getFullYear();
        endMonth.value = endDate.getMonth() + 1;
        endDay.value = endDate.getDate();
      }
    }

    function processDurationInput() {
      const yearsInput = document.getElementById('serviceYears');
      const monthsInput = document.getElementById('serviceMonths');
      const summaryDiv = document.getElementById('durationSummary');
      if (!yearsInput || !monthsInput || !summaryDiv) return;
      let years = parseInt(yearsInput.value) || 0;
      let months = parseInt(monthsInput.value) || 0;
      if (months >= 12) { const addYears = Math.floor(months / 12); years += addYears; months = months % 12; yearsInput.value = years; monthsInput.value = months; }
      summaryDiv.textContent = `æ€»è®¡ï¼š${years}å¹´${months}ä¸ªæœˆ`;
      calculateEndDate();
      if (document.getElementById('unitPrice').value) { calculateTotalAmount(); } else { calculateUnitPrice(); }
    }

    function initEventListeners() {
      const serviceYears = document.getElementById('serviceYears');
      const serviceMonths = document.getElementById('serviceMonths');
      const startYear = document.getElementById('startYear');
      const startMonth = document.getElementById('startMonth');
      const startDay = document.getElementById('startDay');
      if (!serviceYears || !serviceMonths || !startYear || !startMonth || !startDay) return;
      serviceYears.addEventListener('input', processDurationInput);
      serviceMonths.addEventListener('input', processDurationInput);
      startYear.addEventListener('input', calculateEndDate);
      startMonth.addEventListener('input', calculateEndDate);
      startDay.addEventListener('input', calculateEndDate);
      const totalAmount = document.getElementById('totalAmount');
      const userCount = document.querySelector('[name="user_count"]');
      const unitPrice = document.getElementById('unitPrice');
      if (totalAmount) totalAmount.addEventListener('input', calculateUnitPrice);
      if (userCount) { userCount.addEventListener('input', function(){ if (document.getElementById('unitPrice').value) { calculateTotalAmount(); } else { calculateUnitPrice(); } }); }
      if (unitPrice) unitPrice.addEventListener('input', calculateTotalAmount);
    }

    document.addEventListener('DOMContentLoaded', function(){
      initEventListeners();
      // åˆå§‹è§¦å‘ä¸€æ¬¡è®¡ç®—ï¼Œé¿å…å‡ºç°0å¹´0ä¸ªæœˆå’Œç©ºç»“æŸæ—¥æœŸ
      processDurationInput();
      calculateUnitPrice();
    });

    // ç®€å•å¸ƒå±€åˆ‡æ¢ï¼ˆä»…é”€å”®è§†å›¾ä½¿ç”¨ï¼‰
    document.getElementById('btnLayoutCompact')?.addEventListener('click', function(){
      document.body.classList.add('compact-layout');
    });
    document.getElementById('btnLayoutComfortable')?.addEventListener('click', function(){
      document.body.classList.remove('compact-layout');
    });

    // æ¨¡æ¿é€‰æ‹©åŠŸèƒ½ï¼ˆä¸é¦–é¡µä¸€è‡´ï¼‰
    document.querySelectorAll('.btn-template').forEach(button => {
      button.addEventListener('click', function () {
        const templateName = this.dataset.template;
        document.querySelectorAll('.btn-template').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        fetch(`/docx_templates/${templateName}`)
          .then(r => { if(!r.ok) throw new Error('æ¨¡æ¿æ–‡ä»¶è·å–å¤±è´¥'); return r.blob(); })
          .then(blob => {
            const file = new File([blob], templateName, { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
            const fileInput = document.getElementById('fileInput');
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
          })
          .catch(err => { console.error(err); alert('æ¨¡æ¿åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶'); });
      });
    });

    // ç”ŸæˆåˆåŒï¼ˆä¸é¦–é¡µé€»è¾‘ä¸€è‡´ï¼‰
    document.getElementById('contractForm')?.addEventListener('submit', function (e) {
      e.preventDefault();
      const templateFile = document.querySelector('input[type="file"]').files[0];
      if (!templateFile) { alert('è¯·é€‰æ‹©åˆåŒæ¨¡æ¿æ–‡ä»¶'); return; }
      const formData = new FormData(this);
      if (!formData.has('template')) formData.append('template', templateFile);
      fetch('/generate', { method:'POST', body: formData })
        .then(response => { if(!response.ok) return response.text().then(t=>{ throw new Error(t || 'æœåŠ¡å™¨é”™è¯¯'); }); return response.blob(); })
        .then(blob => {
          const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.style.display='none';
          const companyName = document.querySelector('[name="company_name"]').value;
          const jdyAccount = document.querySelector('[name="jdy_account"]').value;
          const startYear = document.getElementById('startYear').value; const endYear = document.getElementById('endYear').value; const currentDate = new Date().toISOString().slice(0,10).replace(/-/g,'');
          a.download = `${startYear}-${endYear}${companyName}-${jdyAccount}-å¸†è½¯ç®€é“äº‘ç»­è´¹åˆåŒ${currentDate}.docx`; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
          if (typeof onContractGenerated === 'function' && jdyAccount.trim()) { onContractGenerated(jdyAccount.trim()); }
          if (typeof showInvoiceEntryButton === 'function') { showInvoiceEntryButton(); }
        })
        .catch(err => { console.error('ç”ŸæˆåˆåŒå¤±è´¥:', err); alert('ç”ŸæˆåˆåŒå¤±è´¥: ' + err.message); });
    });

    // å¡«å……æµ‹è¯•æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function fillTestData(){
      document.querySelector('[name="company_name"]').value = 'æµ‹è¯•ç§‘æŠ€æœ‰é™å…¬å¸';
      document.querySelector('[name="tax_number"]').value = '91330000123456789X';
      document.querySelector('[name="jdy_account"]').value = '12345678abcdefghijklmnop';
      document.getElementById('serviceYears').value = '2';
      document.getElementById('serviceMonths').value = '6';
      document.getElementById('startYear').value = '2025';
      document.getElementById('startMonth').value = '3';
      document.getElementById('startDay').value = '6';
      if (typeof processDurationInput === 'function') processDurationInput();
      document.getElementById('totalAmount').value = '125680.50';
      document.querySelector('[name="user_count"]').value = '50';
      if (typeof performCalculation === 'function') performCalculation();
      if (typeof calculateUnitPrice === 'function') calculateUnitPrice();
    }

    // è·Ÿè¿›æ—¥è®°äº¤äº’ï¼šè¿½åŠ å†™å…¥ï¼Œä¸è¦†ç›–
    async function loadDiary(){
      const res = await fetch('/sales_diary'); const data = await res.json(); const list = document.getElementById('diaryList');
      list.innerHTML = (data.entries||[]).map(e=>`<div class="customer-card-item"><div class="customer-card-date">${e.timestamp}</div><div class="customer-card-company">${e.customer_name||''}ï¼ˆ${e.jdy_account}ï¼‰</div><div class="customer-card-sales">${e.author||''}</div><div class="customer-card-account">${e.note}</div></div>`).join('');
    }
    document.getElementById('btnAddDiary')?.addEventListener('click', async function(){
      const jdy = document.getElementById('diaryJdy').value.trim(); const note = document.getElementById('diaryNote').value.trim(); const company = document.getElementById('diaryCompany').value.trim();
      if(!jdy || !note){ alert('è¯·å¡«å†™ç®€é“äº‘è´¦å·ä¸è·Ÿè¿›è®°å½•'); return; }
      const res = await fetch('/sales_diary', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ jdy_account:jdy, customer_name:company, note })});
      const ok = await res.json(); if(ok && ok.success){ document.getElementById('diaryNote').value=''; await loadDiary(); } else { alert('ä¿å­˜å¤±è´¥'); }
    });
    document.addEventListener('DOMContentLoaded', loadDiary);

    // è‡ªåŠ¨æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯å¹¶å±•ç¤ºåˆ°æ‚¬æµ®é¢æ¿ï¼ˆè¾“å…¥å³æŸ¥ï¼Œæ— éœ€éªŒè¯æŒ‰é’®ï¼‰
    function debounce(fn, wait = 500) { let t; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }; }
    const debounceQueryCustomerSales = debounce(async (event) => {
      const jdy = (event && event.target && event.target.value || '').trim();
      if (jdy.length < 3) return;
      try {
        const res = await fetch('/query_customer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ jdy_id: jdy }) });
        if (!res.ok) throw new Error('æŸ¥è¯¢å¤±è´¥');
        const data = await res.json();
        if (!data.results || data.results.length === 0) throw new Error('æœªæ‰¾åˆ°å®¢æˆ·ä¿¡æ¯');
        const info = data.results[0] || {};
        // æ›´æ–°æ‚¬æµ®é¢æ¿
        const assistId = document.getElementById('assistId');
        const diaryJdyInput = document.getElementById('diaryJdy');
        const assistAnswer = document.getElementById('assistAnswer');
        const assistPanel = document.getElementById('assistPanel');
        if (assistId) assistId.value = jdy;
        if (diaryJdyInput) diaryJdyInput.value = jdy;
        if (assistAnswer) {
          assistAnswer.innerHTML = `
            <div>è´¦å·ï¼š${jdy}</div>
            <div>å…¬å¸ï¼š${info.company_name || info.account_enterprise_name || 'æœªçŸ¥'}</div>
            <div>é›†æˆæ¨¡å¼ï¼š${info.integration_mode || '-'}</div>
            <div>å®¢æˆ·åˆ†ç±»ï¼š${info.customer_classification || '-'}</div>
            <div>è´£ä»»é”€å”®ï¼š${info.sales || info.sales_cn_en || '-'}</div>
            <div>åˆ°æœŸæ—¥æœŸï¼š${info.expiry_date || '-'}</div>
            <div>åº”ç»­ARRï¼š${info.uid_arr || '-'}</div>
          `;
          // è‡ªåŠ¨æ‰“å¼€æ‚¬æµ®é¢æ¿ï¼Œä¾¿äºç«‹å³æŸ¥çœ‹ç»“æœ
          if (assistPanel && !assistPanel.classList.contains('open')) {
            assistPanel.classList.add('open');
            assistPanel.setAttribute('aria-hidden', 'false');
          }
        }
        // è‡ªåŠ¨å¡«å……å…¬å¸ä¸ç¨å·
        const companyNameToUse = (info.company_name && info.company_name !== 'nan') ? info.company_name : (info.account_enterprise_name || '');
        if (companyNameToUse) document.getElementById('company_name').value = companyNameToUse;
        if (info.tax_number && info.tax_number !== 'nan') document.getElementById('tax_number').value = info.tax_number;
      } catch(err) {
        const assistAnswer = document.getElementById('assistAnswer');
        const assistPanel = document.getElementById('assistPanel');
        if (assistAnswer) assistAnswer.textContent = `æŸ¥è¯¢å¤±è´¥ï¼š${err.message || String(err)}`;
        if (assistPanel && !assistPanel.classList.contains('open')) {
          assistPanel.classList.add('open');
          assistPanel.setAttribute('aria-hidden', 'false');
        }
      }
    }, 500);

    // æŸ¥è¯¢è¯¥è´¦å·çš„å®Œæ•´æ—¥è®°
    document.getElementById('btnQueryDiary')?.addEventListener('click', async function(){
      const jdy = (document.getElementById('diaryJdy').value || document.getElementById('jdy_account').value || '').trim();
      if(!jdy){ alert('è¯·å…ˆå¡«å†™ç®€é“äº‘è´¦å·'); return; }
      const res = await fetch(`/sales_diary_query?jdy_account=${encodeURIComponent(jdy)}`);
      const data = await res.json();
      const list = document.getElementById('diaryList');
      const countEl = document.getElementById('diaryCount');
      countEl.textContent = `å…±${data.total||0}æ¡è®°å½•`;
      list.innerHTML = (data.entries||[]).map(e=>`<div class="customer-card-item"><div class="customer-card-date">${e.timestamp}</div><div class="customer-card-company">${e.customer_name||''}ï¼ˆ${e.jdy_account}ï¼‰</div><div class="customer-card-sales">${e.author||''}</div><div class="customer-card-area">${e.note||''}</div></div>`).join('');
    });

    // æ˜¾ç¤ºæœ€åå¯¼å…¥æ—¶é—´ï¼Œå¹¶å°†Excelå¯¼å…¥æ”¾åˆ°ç®€é“äº‘è´¦å·åé¢
    fetch('/get_last_import_time').then(r=>r.json()).then(data=>{ if(data.last_import_time){ const el = document.getElementById('lastImportTime'); if(el) el.textContent = `æœ€åå¯¼å…¥: ${data.last_import_time}`; } });
    document.getElementById('excelUpload')?.addEventListener('change', function(){
      if(!this.files.length) return; const file = this.files[0]; const fd = new FormData(); fd.append('file', file);
      fetch('/upload_excel', { method:'POST', body: fd })
        .then(r=>r.json())
        .then(data=>{ if(data.error){ alert(data.error); } else { const el = document.getElementById('lastImportTime'); if(el) el.textContent = `æœ€åå¯¼å…¥: ${data.last_import_time}`; alert('Excelæ–‡ä»¶å¯¼å…¥æˆåŠŸ'); }})
        .catch(err=>{ alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: '+ err); });
    });

    // é”€å”®è§†å›¾ï¼šä½¿ç”¨ç¤ºä¾‹æ•°æ®æ˜¾ç¤ºåˆ°æœŸå®¢æˆ·æé†’ï¼Œä¸ä¾èµ–æˆ˜åŒºæ•°æ®
    const mockCustomers = [
      { company_name: 'ç¤ºä¾‹ç§‘æŠ€A', jdy_account: 'mockA123', expiry_date: '2025-12-20', sales_person: 'Esther' },
      { company_name: 'æ¼”ç¤ºä¿¡æ¯B', jdy_account: 'mockB456', expiry_date: '2025-12-25', sales_person: 'å¼ ä¸‰' },
      { company_name: 'æ ·ä¾‹åˆ¶é€ C', jdy_account: 'mockC789', expiry_date: '2026-01-05', sales_person: 'æå››' }
    ];
    const todayStr = new Date().toISOString().slice(0,10);
    // è¦†ç›–é»˜è®¤çš„åˆ›å»ºæé†’å‡½æ•°ï¼Œå¼ºåˆ¶ä½¿ç”¨ç¤ºä¾‹æ•°æ®
    window.createExpiringCustomersReminder = function(){
      showExpiringCustomersAlert(mockCustomers, 'daily', todayStr, 'ä»¥ä¸‹ä¸ºç¤ºä¾‹æé†’ï¼Œæ— éœ€æ•°æ®æ–‡ä»¶');
    };
    // ç«‹å³æ˜¾ç¤ºä¸€æ¬¡ç¤ºä¾‹æé†’
    if (typeof showExpiringCustomersAlert === 'function') {
      showExpiringCustomersAlert(mockCustomers, 'daily', todayStr, 'ä»¥ä¸‹ä¸ºç¤ºä¾‹æé†’ï¼Œæ— éœ€æ•°æ®æ–‡ä»¶');
    }
  </script>
</body>
</html>