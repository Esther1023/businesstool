<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estherçš„å·¥ä½œåŠ©ç†</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Estherçš„å·¥ä½œåŠ©ç†</h1>
        </div>

        <div class="card">
            <form id="contractForm" enctype="multipart/form-data" method="post" action="/generate">
                <div class="form-group">
                    <label for="fileInput">å¿«é€Ÿé€‰æ‹©æ¨¡æ¿</label>
                    <div class="template-buttons">
                        <button type="button" class="btn btn-template" data-template="æ ‡å‡†ç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">æ ‡å‡†ç‰ˆ</button>
                        <button type="button" class="btn btn-template" data-template="ä¼ä¸šç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">ä¼ä¸šç‰ˆ</button>
                        <button type="button" class="btn btn-template" data-template="å®šåˆ¶ç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">å®šåˆ¶ç‰ˆ</button>
                        <button type="button" class="btn btn-template" data-template="é’æ˜¥ç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">é’æ˜¥ç‰ˆ</button>
                        <button type="button" class="btn btn-template" data-template="ä¸“ä¸šç‰ˆåˆåŒæ¨¡æ¿_å¸¦å˜é‡.docx">ä¸“ä¸šç‰ˆ</button>
                    </div>
                </div>
                <input type="file" name="template" accept=".docx" required class="file-input" id="fileInput"
                    style="display: none;">
                <div class="file-info" id="fileInfo" style="display: none;"></div>

                <!-- ç”²æ–¹åŸºæœ¬ä¿¡æ¯ section -->
                <div class="form-section">
                    <h3>ç”²æ–¹åŸºæœ¬ä¿¡æ¯</h3>
                    <div class="variables-form">
                        <div class="form-group full-width">
                            <div class="smart-fill-container">
                                <!-- å·¦ä¾§ï¼šOCRè¯†åˆ«åŒºåŸŸ -->
                                <div class="ocr-section">
                                    <div class="image-upload-container">
                                        <div class="image-upload-area" id="imageUploadArea">
                                            <div class="upload-content">
                                                <div class="upload-icon">ğŸ“·</div>
                                                <div class="upload-text">
                                                    <p>æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                                                    <p class="upload-hint">æ”¯æŒ PNGã€JPGã€JPEG ç­‰æ ¼å¼</p>
                                                    <p class="upload-hint">ä¹Ÿå¯ä»¥ç›´æ¥ç²˜è´´æˆªå›¾ï¼ˆCtrl+Vï¼‰</p>
                                                    <p class="upload-hint">ä¸Šä¼ åè‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……è¡¨å•</p>
                                                </div>
                                            </div>
                                            <input type="file" id="imageFileInput" accept="image/*"
                                                style="display: none;">
                                        </div>
                                        <div class="image-preview" id="imagePreview" style="display: none;">
                                            <img id="previewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
                                            <div class="preview-actions">
                                                <button type="button" class="btn btn-secondary"
                                                    id="clearImageBtn">æ¸…é™¤å›¾ç‰‡</button>
                                            </div>
                                        </div>
                                        <div class="ocr-progress" id="ocrProgress" style="display: none;">
                                            <div class="progress-bar">
                                                <div class="progress-fill"></div>
                                            </div>
                                            <p class="progress-text">æ­£åœ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—å¹¶è‡ªåŠ¨å¡«å……...</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- å³ä¾§ï¼šç²˜è´´æ¿è‡ªåŠ¨å¡«å……åŒºåŸŸ -->
                                <div class="clipboard-section">
                                    <div class="clipboard-container">
                                        <div class="clipboard-area" id="clipboardArea">
                                            <div class="clipboard-content">
                                                <div class="clipboard-icon">ğŸ“‹</div>
                                                <div class="clipboard-text">
                                                    <p>æ™ºèƒ½ç²˜è´´è¯†åˆ«</p>
                                                    <p class="clipboard-hint">åœ¨é¡µé¢ä»»æ„ä½ç½®ç²˜è´´æ–‡æœ¬</p>
                                                    <p class="clipboard-hint">ç³»ç»Ÿå°†è‡ªåŠ¨è§£æå¹¶å¡«å……è¡¨å•</p>
                                                </div>
                                            </div>
                                            <textarea id="clipboardTextarea" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬å†…å®¹ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«å¹¶å¡«å……ç›¸å…³å­—æ®µ..."
                                                rows="8"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="company_name">å…¬å¸åç§°ï¼ˆå¿…å¡«ï¼‰</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="company_name" id="company_name" required
                                    oninput="debounceQueryByCompanyName(event)" placeholder="è¾“å…¥2ä¸ªå­—ç¬¦ä»¥ä¸Šå¼€å§‹æœç´¢">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tax_number">ç¨å·ï¼ˆå¿…å¡«ï¼‰</label>
                            <input type="text" class="form-control" name="tax_number" id="tax_number" required>
                        </div>
                        <div class="form-group">
                            <label for="reg_address">æ³¨å†Œåœ°å€</label>
                            <input type="text" class="form-control" name="reg_address" id="reg_address">
                        </div>
                        <div class="form-group">
                            <label for="reg_phone">æ³¨å†Œç”µè¯</label>
                            <input type="text" class="form-control" name="reg_phone" id="reg_phone">
                        </div>
                        <div class="form-group">
                            <label for="bank_name">å¼€æˆ·è¡Œ</label>
                            <input type="text" class="form-control" name="bank_name" id="bank_name">
                        </div>
                        <div class="form-group">
                            <label for="bank_account">è´¦å·</label>
                            <input type="text" class="form-control" name="bank_account" id="bank_account">
                        </div>
                        <div class="form-group">
                            <label for="jdy_account">ç®€é“äº‘è´¦å·ï¼ˆå¿…å¡«ï¼‰</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="jdy_account" id="jdy_account" required
                                    oninput="debounceQueryCustomer(event)" placeholder="è¾“å…¥IDæ˜¾ç¤ºå…¨éƒ¨ä¿¡æ¯">
                                <input type="file" id="excelUpload" accept=".xlsx" style="display: none;">
                                <button type="button" class="btn btn-excel"
                                    onclick="document.getElementById('excelUpload').click()">å¯¼å…¥Excel</button>
                                <button type="button" class="btn btn-shortcut" id="btn-hetiao-inline">ä¸šç»©è¿›åº¦</button>
                                <button type="button" class="btn btn-shortcut" id="btn-sa-inline">SAåå°</button>
                                <button type="button" class="btn btn-shortcut" id="btn-huikuan-inline">æŸ¥æŸ¥å›æ¬¾</button>
                                <button type="button" class="btn btn-shortcut" id="btn-xiadan-inline">è®°å¾—æ¥å£</button>
                                <button type="button" class="btn btn-shortcut" id="btn-qiwei-inline">KMS</button>
                                <button type="button" class="btn btn-shortcut" id="btn-daike-inline">å®¢æˆ·å½’å±</button>
                                <span id="lastImportTime" class="last-import-time"></span>
                            </div>
                        </div>
                        <div id="customerInfo" class="form-group full-width" style="display: none;">
                            <div class="customer-info-box">
                                <div class="info-row">
                                    <label>è´¦å·-ä¼ä¸šåç§°ï¼š</label>
                                    <span id="accountEnterpriseName"></span>
                                </div>
                                <div class="info-row">
                                    <label>é›†æˆæ¨¡å¼ï¼š</label>
                                    <span id="integrationMode"></span>
                                </div>
                                <div class="info-row">
                                    <label>åˆ°æœŸæ—¥æœŸï¼š</label>
                                    <span id="expiryDate"></span>
                                </div>
                                <div class="info-row">
                                    <label>åº”ç»­ARRï¼š</label>
                                    <span id="uidArr"></span>
                                </div>
                                <div class="info-row">
                                    <label>å®¢æˆ·åˆ†ç±»ï¼š</label>
                                    <span id="customerClassification"></span>
                                </div>
                                <div class="info-row">
                                    <label>ç»­è´¹è´£ä»»é”€å”®ï¼š</label>
                                    <span id="salesPerson"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœåŠ¡æœŸé™ä¸è´¹ç”¨ä¿¡æ¯ section -->
                <div class="form-section">
                    <h3>æœåŠ¡æœŸé™ä¸è´¹ç”¨ä¿¡æ¯</h3>
                    <div class="variables-form">
                        <!-- æœåŠ¡æœŸé™å­åŒºåŸŸ -->
                        <div class="form-subsection">
                            <div class="subsection-fields">
                                <div class="form-group service-duration-group">
                                    <label>æœåŠ¡æœŸé™ï¼ˆå¿…å¡«ï¼‰</label>
                                    <div class="duration-inputs">
                                        <div class="duration-input-item">
                                            <label for="serviceYears">å¹´ä»½</label>
                                            <input type="number" class="form-control" name="service_years" required
                                                min="0" id="serviceYears" placeholder="0">
                                        </div>
                                        <div class="duration-input-item">
                                            <label for="serviceMonths">é¢å¤–æœˆä»½</label>
                                            <input type="number" class="form-control" name="service_months" min="0"
                                                max="23" id="serviceMonths" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="duration-summary" id="durationSummary">
                                        æ€»è®¡ï¼š0å¹´0ä¸ªæœˆ
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="startYear">å¼€å§‹å¹´ä»½ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="number" class="form-control" name="start_year" required id="startYear">
                                </div>
                                <div class="form-group">
                                    <label for="startMonth">å¼€å§‹æœˆä»½ï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="number" class="form-control" name="start_month" min="1" max="12"
                                        required id="startMonth">
                                </div>
                                <div class="form-group">
                                    <label for="startDay">å¼€å§‹æ—¥æœŸï¼ˆå¿…å¡«ï¼‰</label>
                                    <input type="number" class="form-control" name="start_day" min="1" max="31" required
                                        id="startDay">
                                </div>
                                <div class="form-group">
                                    <label for="endYear">ç»“æŸå¹´ä»½ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label>
                                    <input type="number" class="form-control" name="end_year" required readonly
                                        id="endYear">
                                </div>
                                <div class="form-group">
                                    <label for="endMonth">ç»“æŸæœˆä»½ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label>
                                    <input type="number" class="form-control" name="end_month" min="1" max="12" required
                                        readonly id="endMonth">
                                </div>
                                <div class="form-group">
                                    <label for="endDay">ç»“æŸæ—¥æœŸï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰</label>
                                    <input type="number" class="form-control" name="end_day" min="1" max="31" required
                                        readonly id="endDay">
                                </div>
                            </div>
                        </div>

                        <!-- è´¹ç”¨ä¿¡æ¯å­åŒºåŸŸ -->
                        <div class="form-subsection">
                            <div class="subsection-fields">
                                <div class="form-group">
                                    <label for="totalAmount">æœåŠ¡è´¹ç”¨é‡‘é¢ï¼ˆæ•°å­—ï¼‰</label>
                                    <input type="number" class="form-control" name="total_amount" required
                                        id="totalAmount" step="0.01" min="0" pattern="[0-9]+(\.[0-9]{1,2})?"
                                        oninput="calculateUnitPrice()">
                                </div>
                                <div class="form-group">
                                    <label for="user_count">ä½¿ç”¨äººæ•°</label>
                                    <input type="number" class="form-control" name="user_count" id="user_count" required
                                        min="1" step="1" pattern="[0-9]+" oninput="calculateUnitPrice()">
                                </div>
                                <div class="form-group">
                                    <label for="unitPrice">å•ä»·ï¼ˆå…ƒ/äºº/å¹´ï¼‰</label>
                                    <input type="number" class="form-control" name="unit_price" required id="unitPrice"
                                        step="0.01" min="0" pattern="[0-9]+(\.[0-9]{1,2})?"
                                        oninput="calculateTotalAmount()">
                                </div>
                                <div class="form-group full-width">
                                    <label for="totalAmountCn">æœåŠ¡è´¹ç”¨é‡‘é¢ï¼ˆå¤§å†™ï¼Œè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                                    <div class="amount-with-buttons">
                                        <input type="text" class="form-control" name="total_amount_cn" required readonly
                                            id="totalAmountCn">
                                        <div class="inline-buttons">
                                            <button type="button" class="btn btn-secondary action-btn" onclick="fillTestData()">
                                                å¡«å……æµ‹è¯•æ•°æ®
                                            </button>
                                            <button type="button" class="btn btn-quote action-btn" onclick="generateQuote()">
                                                ç”ŸæˆæŠ¥ä»·å•
                                            </button>
                                            <button type="submit" class="btn btn-primary action-btn">
                                                ç”ŸæˆåˆåŒ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" name="payment_amount" id="paymentAmount">
                                <input type="hidden" name="payment_amount_cn" id="paymentAmountCn">
                            </div>
                        </div>
                    </div>
                </div>


            </form>
        </div>
    </div>

    <script src="/static/script.js"></script>
    <script>
        // å¡«å……æµ‹è¯•æ•°æ®
        function fillTestData() {
            // å¡«å……ç”²æ–¹åŸºæœ¬ä¿¡æ¯
            document.querySelector('[name="company_name"]').value = 'æµ‹è¯•ç§‘æŠ€æœ‰é™å…¬å¸';
            document.querySelector('[name="tax_number"]').value = '91330000123456789X';
            document.querySelector('[name="reg_address"]').value = 'æµ™æ±Ÿçœæ­å·å¸‚è¥¿æ¹–åŒºæµ‹è¯•è·¯88å·';
            document.querySelector('[name="reg_phone"]').value = '0571-88888888';
            document.querySelector('[name="bank_name"]').value = 'ä¸­å›½æµ‹è¯•é“¶è¡Œæ­å·åˆ†è¡Œ';
            document.querySelector('[name="bank_account"]').value = '1234567890123456789';
            document.querySelector('[name="jdy_account"]').value = '12345678abcdefghijklmnop';

            // å¡«å……æœåŠ¡æœŸé™
            document.getElementById('serviceYears').value = '2';
            document.getElementById('serviceMonths').value = '6';
            document.getElementById('startYear').value = '2025';
            document.getElementById('startMonth').value = '3';
            document.getElementById('startDay').value = '6';

            // è§¦å‘è‡ªåŠ¨è®¡ç®—
            processDurationInput();

            // å¡«å……è´¹ç”¨ä¿¡æ¯
            document.getElementById('totalAmount').value = '125680.50';
            document.querySelector('[name="user_count"]').value = '50';
            // è§¦å‘è‡ªåŠ¨è®¡ç®—å•ä»·
            calculateUnitPrice();


        }

        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');

        // æ•°å­—è½¬ä¸­æ–‡å¤§å†™
        function numberToChinese(num) {
            if (num === 0) {
                return 'é›¶å…ƒæ•´';
            }

            const chineseNums = ['é›¶', 'å£¹', 'è´°', 'å', 'è‚†', 'ä¼', 'é™†', 'æŸ’', 'æŒ', 'ç–'];
            const units = ['', 'æ‹¾', 'ä½°', 'ä»Ÿ'];
            const bigUnits = ['', 'ä¸‡', 'äº¿'];

            num = Math.floor(num);
            let strArr = [];
            let current = num;
            let level = 0;

            while (current > 0) {
                let section = current % 10000;
                let sectionStr = '';
                let hasValue = false;
                let lastHasValue = false;

                for (let i = 0; i < 4; i++) {
                    const digit = section % 10;

                    if (digit === 0) {
                        if (lastHasValue && section > 0) {
                            sectionStr = 'é›¶' + sectionStr;
                        }
                        lastHasValue = false;
                    } else {
                        sectionStr = chineseNums[digit] + units[i] + sectionStr;
                        hasValue = true;
                        lastHasValue = true;
                    }

                    section = Math.floor(section / 10);
                }

                if (hasValue) {
                    sectionStr = sectionStr + bigUnits[level] + (strArr.length > 0 ? 'é›¶' : '');
                }

                if (sectionStr) {
                    strArr.unshift(sectionStr.replace(/é›¶+$/, '').replace(/é›¶+/g, 'é›¶'));
                }

                current = Math.floor(current / 10000);
                level++;
            }

            let result = strArr.join('').replace(/é›¶+$/, '');
            return result + 'å…ƒæ•´';
        }

        // æ›´æ–°ä¸­æ–‡é‡‘é¢
        function updateChineseAmount(value) {
            const num = parseFloat(value) || 0;
            document.getElementById('totalAmountCn').value = numberToChinese(num);
            document.getElementById('paymentAmount').value = num;
            document.getElementById('paymentAmountCn').value = numberToChinese(num);
        }

        // ç²¾ç¡®çš„æ•°å€¼å››èˆäº”å…¥å‡½æ•°
        function roundToTwo(num) {
            return Math.round((num + Number.EPSILON) * 100) / 100;
        }

        // è®¡ç®—å•ä»·
        function calculateUnitPrice() {
            const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
            const userCount = parseFloat(document.querySelector('[name="user_count"]').value) || 0;
            const serviceYears = getTotalServiceYears();

            if (totalAmount && userCount && serviceYears > 0) {
                const unitPrice = totalAmount / (userCount * serviceYears);
                const roundedUnitPrice = roundToTwo(unitPrice);
                document.getElementById('unitPrice').value = roundedUnitPrice.toFixed(2);
                updateChineseAmount(totalAmount);
            }
        }

        // æ ¹æ®å•ä»·è®¡ç®—æ€»é‡‘é¢
        function calculateTotalAmount() {
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const userCount = parseFloat(document.querySelector('[name="user_count"]').value) || 0;
            const serviceYears = getTotalServiceYears();

            if (unitPrice && userCount && serviceYears > 0) {
                const totalAmount = unitPrice * userCount * serviceYears;
                const roundedTotalAmount = roundToTwo(totalAmount);
                document.getElementById('totalAmount').value = roundedTotalAmount.toFixed(2);
                updateChineseAmount(roundedTotalAmount);
            }
        }

        // å¤„ç†å¹´æœˆè¾“å…¥å¹¶è‡ªåŠ¨è½¬æ¢
        function processDurationInput() {
            const yearsInput = document.getElementById('serviceYears');
            const monthsInput = document.getElementById('serviceMonths');
            const summaryDiv = document.getElementById('durationSummary');

            if (!yearsInput || !monthsInput || !summaryDiv) {
                return;
            }

            let years = parseInt(yearsInput.value) || 0;
            let months = parseInt(monthsInput.value) || 0;

            // å¦‚æœæœˆä»½â‰¥12ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºå¹´ä»½
            if (months >= 12) {
                const additionalYears = Math.floor(months / 12);
                years += additionalYears;
                months = months % 12;

                // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
                yearsInput.value = years;
                monthsInput.value = months;
            }

            // æ›´æ–°æ€»è®¡æ˜¾ç¤º
            summaryDiv.textContent = `æ€»è®¡ï¼š${years}å¹´${months}ä¸ªæœˆ`;

            // è®¡ç®—ç»“æŸæ—¥æœŸ
            calculateEndDate();

            // é‡æ–°è®¡ç®—è´¹ç”¨
            if (document.getElementById('unitPrice').value) {
                calculateTotalAmount();
            } else {
                calculateUnitPrice();
            }
        }

        // è·å–æ€»æœåŠ¡æœŸé™ï¼ˆä»¥å¹´ä¸ºå•ä½ï¼ŒåŒ…å«æœˆä»½çš„å°æ•°éƒ¨åˆ†ï¼‰
        function getTotalServiceYears() {
            const years = parseInt(document.getElementById('serviceYears').value) || 0;
            const months = parseInt(document.getElementById('serviceMonths').value) || 0;
            return years + (months / 12);
        }

        // è‡ªåŠ¨è®¡ç®—ç»“æŸæ—¥æœŸ
        function calculateEndDate() {
            const years = parseInt(document.getElementById('serviceYears').value) || 0;
            const months = parseInt(document.getElementById('serviceMonths').value) || 0;
            const startYear = parseInt(document.getElementById('startYear').value) || 0;
            const startMonth = parseInt(document.getElementById('startMonth').value) || 0;
            const startDay = parseInt(document.getElementById('startDay').value) || 0;

            if ((years > 0 || months > 0) && startYear && startMonth && startDay) {
                const endYear = document.getElementById('endYear');
                const endMonth = document.getElementById('endMonth');
                const endDay = document.getElementById('endDay');

                if (!endYear || !endMonth || !endDay) {
                    return;
                }

                // åˆ›å»ºå¼€å§‹æ—¥æœŸ
                const startDate = new Date(startYear, startMonth - 1, startDay);

                // æ·»åŠ å¹´ä»½å’Œæœˆä»½
                const endDate = new Date(startDate);
                endDate.setFullYear(endDate.getFullYear() + years);
                endDate.setMonth(endDate.getMonth() + months);

                // ç»“æŸæ—¥æœŸä¸ºè®¡ç®—æ—¥æœŸçš„å‰ä¸€å¤©
                endDate.setDate(endDate.getDate() - 1);

                endYear.value = endDate.getFullYear();
                endMonth.value = endDate.getMonth() + 1;
                endDay.value = endDate.getDate();
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
            const serviceYears = document.getElementById('serviceYears');
            const serviceMonths = document.getElementById('serviceMonths');
            const startYear = document.getElementById('startYear');
            const startMonth = document.getElementById('startMonth');
            const startDay = document.getElementById('startDay');

            if (!serviceYears || !serviceMonths || !startYear || !startMonth || !startDay) {
                return;
            }

            // æ·»åŠ æœåŠ¡æœŸé™ç›¸å…³å­—æ®µçš„äº‹ä»¶ç›‘å¬
            serviceYears.addEventListener('input', processDurationInput);
            serviceMonths.addEventListener('input', processDurationInput);

            // æ·»åŠ å¼€å§‹æ—¥æœŸå­—æ®µçš„äº‹ä»¶ç›‘å¬ï¼Œç”¨äºè§¦å‘ç»“æŸæ—¥æœŸè®¡ç®—
            startYear.addEventListener('input', calculateEndDate);
            startMonth.addEventListener('input', calculateEndDate);
            startDay.addEventListener('input', calculateEndDate);

            // æ·»åŠ è´¹ç”¨ç›¸å…³å­—æ®µçš„äº‹ä»¶ç›‘å¬
            const totalAmount = document.getElementById('totalAmount');
            const userCount = document.querySelector('[name="user_count"]');
            const unitPrice = document.getElementById('unitPrice');

            if (totalAmount) {
                totalAmount.addEventListener('input', calculateUnitPrice);
            }
            if (userCount) {
                userCount.addEventListener('input', function () {
                    if (document.getElementById('unitPrice').value) {
                        calculateTotalAmount();
                    } else {
                        calculateUnitPrice();
                    }
                });
            }
            if (unitPrice) {
                unitPrice.addEventListener('input', calculateTotalAmount);
            }
        }

        // æ™ºèƒ½å›¾ç‰‡è¯†åˆ«åŠŸèƒ½
        let currentImageFile = null;
        let recognizedFields = {};

        // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½
        function initImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('imageFileInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');
            const clearBtn = document.getElementById('clearImageBtn');
            const ocrProgress = document.getElementById('ocrProgress');
            const ocrResult = document.getElementById('ocrResult');

            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            uploadArea.addEventListener('click', (e) => {
                // ç¡®ä¿ç‚¹å‡»çš„æ˜¯ä¸Šä¼ åŒºåŸŸæœ¬èº«ï¼Œä¸æ˜¯å…¶ä»–å…ƒç´ 
                if (e.target === uploadArea || uploadArea.contains(e.target)) {
                    fileInput.click();
                }
            });

            // æ–‡ä»¶é€‰æ‹©å¤„ç†
            fileInput.addEventListener('change', handleFileSelect);

            // æ‹–æ‹½åŠŸèƒ½
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            // å…¨å±€ç²˜è´´åŠŸèƒ½ - æ™ºèƒ½åˆ†æµå¤„ç†
            document.addEventListener('paste', (e) => {
                // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†ä¸­ç²˜è´´
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA')) {
                    return; // å…è®¸åœ¨è¾“å…¥æ¡†ä¸­æ­£å¸¸ç²˜è´´æ–‡æœ¬
                }

                const items = e.clipboardData.items;
                let hasImage = false;
                let hasText = false;

                // æ£€æŸ¥ç²˜è´´å†…å®¹ç±»å‹
                for (let item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        hasImage = true;
                        break;
                    }
                    if (item.type === 'text/plain') {
                        hasText = true;
                    }
                }

                // ä¼˜å…ˆå¤„ç†å›¾ç‰‡
                if (hasImage) {
                    e.preventDefault();
                    for (let item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            const file = item.getAsFile();
                            if (file) {
                                handleFile(file);
                                showPasteSuccess('å›¾ç‰‡ç²˜è´´æˆåŠŸï¼æ­£åœ¨è¿›è¡ŒOCRè¯†åˆ«...');
                            }
                            break;
                        }
                    }
                }
                // å¤„ç†æ–‡æœ¬
                else if (hasText) {
                    e.preventDefault();
                    for (let item of items) {
                        if (item.type === 'text/plain') {
                            item.getAsString((text) => {
                                if (text.trim()) {
                                    handleClipboardText(text.trim());
                                    showClipboardSuccess('æ–‡æœ¬ç²˜è´´æˆåŠŸï¼æ­£åœ¨æ™ºèƒ½è§£æ...');
                                }
                            });
                            break;
                        }
                    }
                }
            });

            // æ¸…é™¤å›¾ç‰‡æŒ‰é’®
            clearBtn.addEventListener('click', clearImage);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if (!file) {
                alert('æœªé€‰æ‹©æ–‡ä»¶');
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/bmp', 'image/webp', 'image/tiff'];
            if (!allowedTypes.includes(file.type)) {
                alert(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.type}\nè¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆPNGã€JPGã€JPEGã€GIFã€BMPã€WebPã€TIFFï¼‰`);
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ10MBé™åˆ¶ï¼‰
            if (file.size > 10 * 1024 * 1024) {
                alert(`æ–‡ä»¶å¤§å°è¿‡å¤§: ${(file.size / 1024 / 1024).toFixed(2)}MB\nè¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶`);
                return;
            }

            currentImageFile = file;
            showImagePreview(file);

            // è‡ªåŠ¨å¼€å§‹è¯†åˆ«
            setTimeout(() => {
                processImage();
            }, 800);
        }

        function showImagePreview(file) {
            const uploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            const previewImage = document.getElementById('previewImage');

            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                uploadArea.style.display = 'none';
                imagePreview.style.display = 'block';
            };
            reader.onerror = (e) => {
                console.error('å›¾ç‰‡è¯»å–å¤±è´¥:', e);
                alert('å›¾ç‰‡è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            currentImageFile = null;
            recognizedFields = {};

            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('ocrProgress').style.display = 'none';
            document.getElementById('ocrResult').style.display = 'none';
            document.getElementById('imageFileInput').value = '';

            resetUploadArea();
        }

        function showPasteSuccess(message = 'å›¾ç‰‡ç²˜è´´æˆåŠŸï¼') {
            // åˆ›å»ºä¸´æ—¶æç¤º
            const uploadArea = document.getElementById('imageUploadArea');
            const originalContent = uploadArea.innerHTML;

            uploadArea.innerHTML = `
                <div class="upload-content">
                    <div class="upload-icon">âœ…</div>
                    <div class="upload-text">
                        <p>${message}</p>
                        <p class="upload-hint">æ­£åœ¨å¤„ç†...</p>
                    </div>
                </div>
            `;

            // 2ç§’åæ¢å¤åŸå†…å®¹
            setTimeout(() => {
                uploadArea.innerHTML = originalContent;
            }, 2000);
        }

        // å¤„ç†ç²˜è´´æ¿æ–‡æœ¬
        function handleClipboardText(text) {
            // å‘é€åˆ°åç«¯è§£æ
            fetch('/parse_text', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: text })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.fields) {
                        // ç›´æ¥åº”ç”¨è§£æç»“æœåˆ°è¡¨å•
                        autoFillFields(data.fields);
                    }
                })
                .catch(error => {
                    console.error('è§£ææ–‡æœ¬é”™è¯¯:', error);
                });
        }

        // æ˜¾ç¤ºç²˜è´´æ¿æˆåŠŸæç¤º
        function showClipboardSuccess(message = 'æ–‡æœ¬ç²˜è´´æˆåŠŸï¼') {
            const clipboardArea = document.getElementById('clipboardArea');
            const clipboardContent = clipboardArea?.querySelector('.clipboard-content');

            if (!clipboardContent) return;

            const originalContent = clipboardContent.innerHTML;

            clipboardContent.innerHTML = `
                <div class="clipboard-icon">âœ…</div>
                <div class="clipboard-text">
                    <p>${message}</p>
                    <p class="clipboard-hint">æ­£åœ¨æ™ºèƒ½è§£æ...</p>
                </div>
            `;

            // 2ç§’åæ¢å¤åŸå†…å®¹
            setTimeout(() => {
                clipboardContent.innerHTML = originalContent;
            }, 2000);
        }

        // è‡ªåŠ¨å¡«å……å­—æ®µåˆ°è¡¨å•
        function autoFillFields(fields) {
            for (const [fieldName, value] of Object.entries(fields)) {
                const input = document.getElementById(fieldName);
                if (input && value) {
                    input.value = value;
                    input.classList.add('auto-filled');

                    // ç§»é™¤é«˜äº®æ•ˆæœ
                    setTimeout(() => {
                        input.classList.remove('auto-filled');
                    }, 2000);

                    // è§¦å‘è¾“å…¥äº‹ä»¶ï¼ˆç”¨äºå…¬å¸åç§°æœç´¢ç­‰ï¼‰
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }

        function processImage() {
            if (!currentImageFile) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                return;
            }

            const ocrProgress = document.getElementById('ocrProgress');
            const ocrResult = document.getElementById('ocrResult');

            // æ˜¾ç¤ºè¿›åº¦æ¡
            ocrProgress.style.display = 'block';
            ocrResult.style.display = 'none';

            // åˆ›å»ºFormData
            const formData = new FormData();
            formData.append('image', currentImageFile);

            // å‘é€OCRè¯·æ±‚
            fetch('/ocr_process', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    ocrProgress.style.display = 'none';

                    if (data.success) {
                        recognizedFields = data.parsed_fields;
                        // æ˜¾ç¤ºç®€åŒ–çš„æˆåŠŸæç¤ºå¹¶ç›´æ¥å¡«å……
                        showOCRSuccess(data);
                    } else {
                        console.error('OCRè¯†åˆ«å¤±è´¥:', data.error);

                        // æ£€æŸ¥æ˜¯å¦æ˜¯OCRä¸å¯ç”¨çš„é”™è¯¯
                        if (data.ocr_available === false || data.tesseract_available === false) {
                            showOCRUnavailable(data.error);
                        } else {
                            alert('å›¾ç‰‡è¯†åˆ«å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                            resetUploadArea();
                        }
                    }
                })
                .catch(error => {
                    ocrProgress.style.display = 'none';
                    console.error('OCRè¯·æ±‚å¤±è´¥:', error);
                    alert('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼š' + error.message + '\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•');
                    resetUploadArea();
                });
        }

        function showOCRSuccess(data) {
            const uploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');
            const ocrResult = document.getElementById('ocrResult');

            // éšè—å›¾ç‰‡é¢„è§ˆ
            imagePreview.style.display = 'none';

            // åº”ç”¨å­—æ®µåˆ°è¡¨å•
            const result = applyFieldsToFormDirectly(data.parsed_fields);

            // éšè—OCRç»“æœåŒºåŸŸï¼ˆä¸å†éœ€è¦ï¼‰
            ocrResult.style.display = 'none';

            // ç›´æ¥æ¢å¤ä¸Šä¼ åŒºåŸŸï¼Œä¸æ˜¾ç¤ºæˆåŠŸæç¤º
            resetUploadArea();
        }

        function resetUploadArea() {
            const uploadArea = document.getElementById('imageUploadArea');
            uploadArea.innerHTML = `
                <div class="upload-content">
                    <div class="upload-icon">ğŸ“·</div>
                    <div class="upload-text">
                        <p>æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                        <p class="upload-hint">æ”¯æŒ PNGã€JPGã€JPEG ç­‰æ ¼å¼ï¼Œæœ€å¤§ 10MB</p>
                        <p class="upload-hint">ä¹Ÿå¯ä»¥ç›´æ¥ç²˜è´´å‰ªè´´æ¿ä¸­çš„æˆªå›¾ï¼ˆCtrl+V / Cmd+Vï¼‰</p>
                    </div>
                </div>
            `;
            currentImageFile = null;
        }

        function showOCRUnavailable(errorMessage) {
            const uploadArea = document.getElementById('imageUploadArea');
            const imagePreview = document.getElementById('imagePreview');

            // éšè—å›¾ç‰‡é¢„è§ˆ
            imagePreview.style.display = 'none';

            // æ˜¾ç¤ºOCRä¸å¯ç”¨çš„è¯¦ç»†ä¿¡æ¯
            uploadArea.innerHTML = `
                <div class="upload-content">
                    <div class="upload-icon">âš ï¸</div>
                    <div class="upload-text">
                        <p><strong>OCRåŠŸèƒ½ä¸å¯ç”¨</strong></p>
                        <p class="upload-hint">éœ€è¦å®‰è£…OCRä¾èµ–åŒ…æ‰èƒ½è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—</p>
                        <div style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; text-align: left; font-size: 12px;">
                            <p><strong>å®‰è£…æ­¥éª¤ï¼š</strong></p>
                            <p>1. å®‰è£…Tesseract OCRå¼•æ“ï¼š</p>
                            <code>brew install tesseract tesseract-lang</code>
                            <p>2. å®‰è£…Pythonä¾èµ–åŒ…ï¼š</p>
                            <code>pip install pytesseract pillow opencv-python</code>
                            <p>3. é‡å¯åº”ç”¨</p>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="resetUploadArea()" style="margin-top: 10px;">è¿”å›ä¸Šä¼ </button>
                    </div>
                </div>
            `;
            uploadArea.style.display = 'block';
        }

        function getFieldLabel(fieldName) {
            const labels = {
                'company_name': 'å…¬å¸åç§°',
                'tax_number': 'ç¨å·',
                'reg_address': 'æ³¨å†Œåœ°å€',
                'reg_phone': 'æ³¨å†Œç”µè¯',
                'bank_name': 'å¼€æˆ·è¡Œ',
                'bank_account': 'é“¶è¡Œè´¦å·',
                'contact_name': 'è”ç³»äºº',
                'contact_phone': 'è”ç³»ç”µè¯',
                'mail_address': 'é‚®å¯„åœ°å€',
                'jdy_account': 'ç®€é“äº‘è´¦å·'
            };
            return labels[fieldName] || fieldName;
        }

        // å†…è”ç¼–è¾‘åŠŸèƒ½
        function startInlineEdit(element) {
            if (element.classList.contains('editing')) {
                return; // å·²ç»åœ¨ç¼–è¾‘çŠ¶æ€
            }

            const fieldName = element.getAttribute('data-field');
            const currentValue = element.textContent;

            // æ·»åŠ ç¼–è¾‘çŠ¶æ€æ ·å¼
            element.classList.add('editing');

            // åˆ›å»ºè¾“å…¥æ¡†
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'field-value-input';
            input.value = currentValue;

            // æ›¿æ¢å†…å®¹
            element.innerHTML = '';
            element.appendChild(input);

            // èšç„¦å¹¶é€‰ä¸­æ–‡æœ¬
            input.focus();
            input.select();

            // ä¿å­˜ç¼–è¾‘
            function saveEdit() {
                const newValue = input.value.trim();
                if (newValue !== currentValue) {
                    recognizedFields[fieldName] = newValue;
                }

                // æ¢å¤æ˜¾ç¤º
                element.classList.remove('editing');
                element.textContent = newValue || currentValue;
                element.onclick = () => startInlineEdit(element);
            }

            // å–æ¶ˆç¼–è¾‘
            function cancelEdit() {
                element.classList.remove('editing');
                element.textContent = currentValue;
                element.onclick = () => startInlineEdit(element);
            }

            // äº‹ä»¶ç›‘å¬
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });

            // ç§»é™¤ç‚¹å‡»äº‹ä»¶ï¼Œé¿å…é‡å¤è§¦å‘
            element.onclick = null;
        }

        // ç›´æ¥åº”ç”¨å­—æ®µåˆ°è¡¨å•ï¼ˆæ–°çš„ç®€åŒ–æµç¨‹ï¼‰
        function applyFieldsToFormDirectly(fields) {
            let appliedCount = 0;
            const appliedFields = [];

            for (const [fieldName, value] of Object.entries(fields)) {
                const formField = document.querySelector(`[name="${fieldName}"]`);
                if (formField && value.trim()) {
                    formField.value = value.trim();
                    // æ·»åŠ è§†è§‰åé¦ˆ
                    formField.classList.add('auto-filled');
                    setTimeout(() => {
                        formField.classList.remove('auto-filled');
                    }, 3000);
                    appliedCount++;
                    appliedFields.push(getFieldLabel(fieldName));
                }
            }

            if (appliedCount > 0) {
                // è§¦å‘ç›¸å…³äº‹ä»¶ï¼ˆå¦‚å…¬å¸åç§°æŸ¥è¯¢ï¼‰
                const companyNameField = document.querySelector('[name="company_name"]');
                if (companyNameField && companyNameField.value) {
                    // è§¦å‘å…¬å¸åç§°æŸ¥è¯¢
                    setTimeout(() => {
                        const event = new Event('input', { bubbles: true });
                        companyNameField.dispatchEvent(event);
                    }, 500);
                }
            }

            return { appliedCount, appliedFields };
        }

        // ä¿ç•™åŸæœ‰çš„åº”ç”¨å‡½æ•°ï¼ˆç”¨äºæ‰‹åŠ¨åº”ç”¨ï¼‰
        function applyFieldsToForm() {
            const result = applyFieldsToFormDirectly(recognizedFields);
            if (result.appliedCount > 0) {
                alert(`æˆåŠŸåº”ç”¨ ${result.appliedCount} ä¸ªå­—æ®µåˆ°è¡¨å•`);
            } else {
                alert('æ²¡æœ‰å¯åº”ç”¨çš„å­—æ®µ');
            }
        }

        // æ˜¾ç¤º/éšè—åŸå§‹æ–‡æœ¬
        function toggleRawText() {
            const rawTextDiv = document.getElementById('rawText');
            const btn = document.getElementById('showRawTextBtn');

            if (rawTextDiv.style.display === 'none') {
                rawTextDiv.style.display = 'block';
                btn.textContent = 'éšè—åŸæ–‡';
            } else {
                rawTextDiv.style.display = 'none';
                btn.textContent = 'æŸ¥çœ‹åŸæ–‡';
            }
        }

        // åˆå§‹åŒ–æ™ºèƒ½è¡¨å•å¡«å……åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function () {
            initImageUpload();
        });

        // æ¨¡æ¿é€‰æ‹©åŠŸèƒ½
        document.querySelectorAll('.btn-template').forEach(button => {
            button.addEventListener('click', function () {
                const templateName = this.dataset.template;

                // ç§»é™¤å…¶ä»–æŒ‰é’®çš„activeçŠ¶æ€
                document.querySelectorAll('.btn-template').forEach(btn => {
                    btn.classList.remove('active');
                });

                // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
                this.classList.add('active');

                // ä»æœåŠ¡å™¨è·å–æ¨¡æ¿æ–‡ä»¶
                fetch(`/docx_templates/${templateName}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`æ¨¡æ¿æ–‡ä»¶è·å–å¤±è´¥: ${response.status}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        // åˆ›å»ºæ–‡ä»¶å¯¹è±¡
                        const file = new File([blob], templateName, {
                            type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                        });

                        // è®¾ç½®åˆ°æ–‡ä»¶è¾“å…¥æ¡†
                        const fileInput = document.getElementById('fileInput');

                        // ä½¿ç”¨ DataTransfer API
                        try {
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            fileInput.files = dataTransfer.files;
                        } catch (error) {
                            console.error('æ–‡ä»¶è®¾ç½®å¤±è´¥:', error);
                            alert('æ–‡ä»¶è®¾ç½®å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶');
                        }
                    })
                    .catch(error => {
                        console.error('æ¨¡æ¿åŠ è½½å¤±è´¥:', error);
                        alert('æ¨¡æ¿åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶');
                    });
            });
        });





        // æ£€æŸ¥å¹¶æ˜¾ç¤ºæœ€åå¯¼å…¥æ—¶é—´
        fetch('/get_last_import_time')
            .then(response => response.json())
            .then(data => {
                if (data.last_import_time) {
                    document.getElementById('lastImportTime').textContent = `æœ€åå¯¼å…¥: ${data.last_import_time}`;
                }
            });

        // Excelæ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('excelUpload').addEventListener('change', function (e) {
            if (!this.files.length) return;

            const file = this.files[0];
            const formData = new FormData();
            formData.append('file', file);

            fetch('/upload_excel', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        document.getElementById('lastImportTime').textContent = `æœ€åå¯¼å…¥: ${data.last_import_time}`;
                        alert('Excelæ–‡ä»¶å¯¼å…¥æˆåŠŸ');
                    }
                })
                .catch(error => {
                    alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + error);
                });

            // æ¸…é™¤æ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
            this.value = '';
        });

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // å®¢æˆ·æŸ¥è¯¢åŠŸèƒ½
        const debounceQueryCustomer = debounce((event) => {
            const jdyAccount = event.target.value;
            if (jdyAccount.length < 3) return; // è‡³å°‘è¾“å…¥3ä¸ªå­—ç¬¦æ‰å¼€å§‹æŸ¥è¯¢
            queryCustomer(jdyAccount);
        }, 500); // 500ms é˜²æŠ–

        async function queryCustomer(jdyAccount) {
            try {
                const response = await fetch('/query_customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ jdy_id: jdyAccount })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('æŸ¥è¯¢é”™è¯¯:', error);
                    throw new Error(error.error || 'æŸ¥è¯¢å¤±è´¥');
                }

                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°å®¢æˆ·ä¿¡æ¯');
                }

                // ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœ
                const customerData = data.results[0];

                // æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯
                document.getElementById('accountEnterpriseName').textContent = customerData.account_enterprise_name || '';
                document.getElementById('integrationMode').textContent = customerData.integration_mode || '';
                document.getElementById('expiryDate').textContent = customerData.expiry_date || '';
                document.getElementById('uidArr').textContent = customerData.uid_arr || '';
                const customerClassification = document.getElementById('customerClassification');
                const classificationText = customerData.customer_classification || '';

                // æ£€æŸ¥æ˜¯å¦æ˜¯ç²¾ç¡®çš„"æˆ˜åŒºNameåå•"
                if (classificationText === 'æˆ˜åŒºNameåå•') {
                    // ç›´æ¥è®¾ç½®å†…è”æ ·å¼ï¼Œä½¿ç”¨!importantç¡®ä¿ä¼˜å…ˆçº§
                    customerClassification.style.color = '#1890ff !important'; // æ˜æ˜¾çš„è“è‰²
                    customerClassification.style.fontWeight = '500';
                    customerClassification.style.padding = '2px 6px';
                    customerClassification.style.borderRadius = '4px';
                    customerClassification.style.backgroundColor = 'rgba(24, 144, 255, 0.1)';

                    // è®¾ç½®æ–‡æœ¬å†…å®¹å¹¶æ·»åŠ æé†’
                    customerClassification.textContent = classificationText + ' âš ï¸ æ‰¾é”€å”® ';
                } else {
                    // é‡ç½®æ‰€æœ‰æ ·å¼
                    customerClassification.style.color = '';
                    customerClassification.style.fontWeight = '';
                    customerClassification.style.padding = '';
                    customerClassification.style.borderRadius = '';
                    customerClassification.style.backgroundColor = '';

                    // åªæ˜¾ç¤ºåŸå§‹æ–‡æœ¬ï¼Œä¸æ·»åŠ æé†’
                    customerClassification.textContent = classificationText;
                }
                document.getElementById('salesPerson').textContent = customerData.sales || '';
                
                // å®‰å…¨è®¾ç½®å¯é€‰å…ƒç´ çš„å†…å®¹
                const salesCnEnElement = document.getElementById('salesCnEn');
                if (salesCnEnElement) {
                    salesCnEnElement.textContent = customerData.sales_cn_en || '';
                }
                
                const jdySalesElement = document.getElementById('jdySales');
                if (jdySalesElement) {
                    jdySalesElement.textContent = customerData.jdy_sales || '';
                }

                // è‡ªåŠ¨å¡«å……å…¬å¸åç§°ï¼ˆä¼˜å…ˆä½¿ç”¨å…¬å¸åç§°ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨è´¦å·-ä¼ä¸šåç§°ï¼‰
                const companyNameToUse = (customerData.company_name && customerData.company_name !== 'nan')
                    ? customerData.company_name
                    : customerData.account_enterprise_name || '';
                document.querySelector('[name="company_name"]').value = companyNameToUse;

                // è‡ªåŠ¨å¡«å……ç¨å·
                if (customerData.tax_number && customerData.tax_number !== 'nan') {
                    document.querySelector('[name="tax_number"]').value = customerData.tax_number;
                }

                // æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯æ¡†
                document.getElementById('customerInfo').style.display = 'block';

                // æ˜¾ç¤ºä¸‹å•æµç¨‹æé†’
                showOrderProcessTip(customerData.integration_mode);
            } catch (error) {
                alert(error.message);
                document.getElementById('customerInfo').style.display = 'none';
            }
        }

        // å®¢æˆ·æŸ¥è¯¢åŠŸèƒ½ï¼ˆé€šè¿‡å…¬å¸åç§°ï¼‰
        const debounceQueryByCompanyName = debounce((event) => {
            const companyName = event.target.value;
            if (companyName.length < 2) return; // è‡³å°‘è¾“å…¥2ä¸ªå­—ç¬¦æ‰å¼€å§‹æŸ¥è¯¢
            queryByCompanyName(companyName);
        }, 500); // 500ms é˜²æŠ–

        async function queryByCompanyName(companyName) {
            try {
                const response = await fetch('/query_customer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ company_name: companyName })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('æŸ¥è¯¢é”™è¯¯:', error);
                    throw new Error(error.error || 'æŸ¥è¯¢å¤±è´¥');
                }

                const data = await response.json();

                if (!data.results || data.results.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°å®¢æˆ·ä¿¡æ¯');
                }

                // ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœ
                const customerData = data.results[0];

                // æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯å¹¶è‡ªåŠ¨å¡«å……ç›¸å…³å­—æ®µ
                updateCustomerInfo(customerData);
            } catch (error) {
                alert(error.message);
                document.getElementById('customerInfo').style.display = 'none';
            }
        }

        // æ›´æ–°å®¢æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateCustomerInfo(customerData) {
            // æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯
            document.getElementById('accountEnterpriseName').textContent = customerData.account_enterprise_name || '';
            document.getElementById('integrationMode').textContent = customerData.integration_mode || '';
            document.getElementById('expiryDate').textContent = customerData.expiry_date || '';
            document.getElementById('uidArr').textContent = customerData.uid_arr || '';
            const customerClassification = document.getElementById('customerClassification');
            const classificationText = customerData.customer_classification || '';

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç²¾ç¡®çš„"æˆ˜åŒºNameåå•"
            if (classificationText === 'æˆ˜åŒºNameåå•') {
                // ç›´æ¥è®¾ç½®å†…è”æ ·å¼ï¼Œä½¿ç”¨!importantç¡®ä¿ä¼˜å…ˆçº§
                customerClassification.style.color = '#1890ff !important'; // æ˜æ˜¾çš„è“è‰²
                customerClassification.style.fontWeight = '500';
                customerClassification.style.padding = '2px 6px';
                customerClassification.style.borderRadius = '4px';
                customerClassification.style.backgroundColor = 'rgba(24, 144, 255, 0.1)';

                // è®¾ç½®æ–‡æœ¬å†…å®¹å¹¶æ·»åŠ æé†’
                customerClassification.textContent = classificationText + ' âš ï¸ æ‰¾é”€å”® ';
            } else {
                // é‡ç½®æ‰€æœ‰æ ·å¼
                customerClassification.style.color = '';
                customerClassification.style.fontWeight = '';
                customerClassification.style.padding = '';
                customerClassification.style.borderRadius = '';
                customerClassification.style.backgroundColor = '';

                // åªæ˜¾ç¤ºåŸå§‹æ–‡æœ¬ï¼Œä¸æ·»åŠ æé†’
                customerClassification.textContent = classificationText;
            }
            document.getElementById('salesPerson').textContent = customerData.sales || '';
            
            // å®‰å…¨è®¾ç½®å¯é€‰å…ƒç´ çš„å†…å®¹
            const salesCnEnElement = document.getElementById('salesCnEn');
            if (salesCnEnElement) {
                salesCnEnElement.textContent = customerData.sales_cn_en || '';
            }
            
            const jdySalesElement = document.getElementById('jdySales');
            if (jdySalesElement) {
                jdySalesElement.textContent = customerData.jdy_sales || '';
            }

            // è‡ªåŠ¨å¡«å……ç®€é“äº‘è´¦å·ï¼ˆä½¿ç”¨ç”¨æˆ·IDï¼‰
            if (customerData.user_id) {
                document.querySelector('[name="jdy_account"]').value = customerData.user_id;
            }

            // è‡ªåŠ¨å¡«å……å…¬å¸åç§°ï¼ˆä¼˜å…ˆä½¿ç”¨å…¬å¸åç§°ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨è´¦å·-ä¼ä¸šåç§°ï¼‰
            const companyNameToUse = (customerData.company_name && customerData.company_name !== 'nan')
                ? customerData.company_name
                : customerData.account_enterprise_name || '';
            document.querySelector('[name="company_name"]').value = companyNameToUse;

            // è‡ªåŠ¨å¡«å……ç¨å·
            if (customerData.tax_number && customerData.tax_number !== 'nan') {
                document.querySelector('[name="tax_number"]').value = customerData.tax_number;
            }

            // æ˜¾ç¤ºå®¢æˆ·ä¿¡æ¯æ¡†
            document.getElementById('customerInfo').style.display = 'block';
        }

        document.getElementById('contractForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const templateFile = document.querySelector('input[type="file"]').files[0];
            if (!templateFile) {
                alert('è¯·é€‰æ‹©åˆåŒæ¨¡æ¿æ–‡ä»¶');
                return;
            }

            // åˆ›å»ºFormDataå¯¹è±¡å¹¶æ·»åŠ æ‰€æœ‰è¡¨å•æ•°æ®
            const formData = new FormData(this);

            // ç¡®ä¿æ–‡ä»¶å’Œå…¶ä»–å¿…è¦å­—æ®µéƒ½å·²æ·»åŠ 
            if (!formData.has('template')) {
                formData.append('template', templateFile);
            }

            // æäº¤è¡¨å•
            // æäº¤è¡¨å•
            fetch('/generate', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            console.error('æœåŠ¡å™¨å“åº”é”™è¯¯:', response.status, text);
                            // å°è¯•è§£æJSONé”™è¯¯ä¿¡æ¯
                            try {
                                const errorObj = JSON.parse(text);
                                throw new Error(errorObj.error || `æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${text}`);
                            } catch (e) {
                                // å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥æ˜¾ç¤ºæ–‡æœ¬
                                throw new Error(`æœåŠ¡å™¨é”™è¯¯ (${response.status}): ${text}`);
                            }
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;

                    // è®¾ç½®æ–‡ä»¶å
                    const companyName = document.querySelector('[name="company_name"]').value;
                    const jdyAccount = document.querySelector('[name="jdy_account"]').value;
                    const startYear = document.getElementById('startYear').value;
                    const endYear = document.getElementById('endYear').value;
                    const currentDate = new Date().toISOString().slice(0, 10).replace(/-/g, '');

                    // æ–°çš„æ–‡ä»¶å‘½åæ ¼å¼ï¼šå¼€å§‹å¹´ä»½-ç»“æŸå¹´ä»½+å…¬å¸åç§°+è´¦å·ID+å¸†è½¯ç®€é“äº‘ç»­è´¹åˆåŒ+åˆåŒç”Ÿæˆæ—¥æœŸ
                    a.download = `${startYear}-${endYear}${companyName}-${jdyAccount}-å¸†è½¯ç®€é“äº‘ç»­è´¹åˆåŒ${currentDate}.docx`;

                    // è§¦å‘ä¸‹è½½
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    // ç”ŸæˆåˆåŒæˆåŠŸåè‡ªåŠ¨æ¨è¿›åˆ°åˆåŒé˜¶æ®µ
                    const jdyAccountTrimmed = jdyAccount.trim();
                    if (jdyAccountTrimmed && typeof onContractGenerated === 'function') {
                        onContractGenerated(jdyAccountTrimmed);
                    }

                    // æ˜¾ç¤ºå¼€ç¥¨å½•å…¥æŒ‰é’®
                    showInvoiceEntryButton();
                })
                .catch(error => {
                    console.error('ç”ŸæˆåˆåŒå¤±è´¥:', error);
                    alert('ç”ŸæˆåˆåŒå¤±è´¥: ' + error.message);
                });
        });

        // æ˜¾ç¤ºå¼€ç¥¨å½•å…¥æŒ‰é’®
        function showInvoiceEntryButton() {
            // åœ¨é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºå¼€ç¥¨å½•å…¥æŒ‰é’®
            const existingButton = document.getElementById('invoiceEntryButton');
            if (existingButton) {
                existingButton.remove();
            }

            const button = document.createElement('div');
            button.id = 'invoiceEntryButton';
            button.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 1000;
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
                cursor: pointer;
                font-size: 16px;
                font-weight: bold;
                transition: all 0.3s ease;
                animation: pulse 2s infinite;
            `;
            button.innerHTML = 'ğŸ“‹ å¼€ç¥¨å½•å…¥ (ç‚¹å‡»è¿›å…¥)';

            // æ·»åŠ è„‰å†²åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse {
                    0% { transform: scale(1); }
                    50% { transform: scale(1.05); }
                    100% { transform: scale(1); }
                }
            `;
            document.head.appendChild(style);

            button.addEventListener('click', function () {
                window.open('https://www.jiandaoyun.com/dashboard#/app/5a015dd12d85443cacd1b893/form/020100200000000000000001', '_blank');
                // ç‚¹å‡»åç«‹å³éšè—
                this.remove();
            });

            button.addEventListener('mouseenter', function () {
                this.style.transform = 'translateY(-3px) scale(1.02)';
                this.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.6)';
            });

            button.addEventListener('mouseleave', function () {
                this.style.transform = 'translateY(0) scale(1)';
                this.style.boxShadow = '0 4px 20px rgba(40, 167, 69, 0.4)';
            });

            document.body.appendChild(button);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const assistAnswer = document.getElementById('assistAnswer');
            if (assistAnswer) {
                assistAnswer.innerHTML = 'âœ… åˆåŒç”ŸæˆæˆåŠŸï¼<br>ğŸ“‹ <strong>å¼€ç¥¨å½•å…¥æŒ‰é’®å·²æ˜¾ç¤ºåœ¨å³ä¸Šè§’</strong>ï¼ˆ15ç§’åè‡ªåŠ¨éšè—ï¼‰';
                assistAnswer.style.color = '#28a745';
            }

            // 15ç§’åè‡ªåŠ¨éšè—ï¼ˆå»¶é•¿æ˜¾ç¤ºæ—¶é—´ï¼‰
            setTimeout(() => {
                if (button && button.parentNode) {
                    button.style.opacity = '0';
                    button.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        if (button && button.parentNode) {
                            button.remove();
                        }
                    }, 300);
                }
            }, 15000);
        }

        // åˆå§‹åŒ–
        initEventListeners();
    </script>

    <!-- æ‚¬æµ®çƒå®¹å™¨ -->
    <div id="assistBall" class="assist-ball" title="å¿«æ·æ“ä½œï¼ˆCtrl/âŒ˜ + Shift + Kï¼‰">âš¡</div>
    <div id="assistPanel" class="assist-panel" aria-hidden="true">
        <div class="assist-panel-header">
            <strong>å¿«é€Ÿæ“ä½œ</strong>
            <div class="monitor-controls">
                <button id="assistClose" class="btn btn-secondary"
                    style="min-width:auto;padding:6px 10px;background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:4px;font-size:16px;font-weight:bold;">âœ•</button>
            </div>
        </div>
        <div class="assist-panel-body">
            <!-- è¯†åˆ«ä½ çš„å”¯ä¸€IDï¼šç®€é“äº‘è´¦å· -->
            <input id="assistId" class="assist-input" placeholder="ç®€é“äº‘è´¦å·ï¼ˆå¤–éƒ¨IDï¼‰è‡ªåŠ¨è¯†åˆ«ï¼Œå¿…è¦æ—¶æ‰‹å¡«">
            <div class="assist-row">
                <button id="btnStageContract" class="btn">åˆåŒ</button>
                <button id="btnStageInvoice" class="btn">å¼€ç¥¨</button>
            </div>
            <div class="assist-row">
                <button id="btnStageAdvanceInvoice" class="btn">æå‰å¼€</button>
                <button id="btnStageInvalid" class="btn">æ— æ•ˆ</button>
                <button id="btnStageUpsell" class="btn">å¢è´­</button>
                <button id="btnStageLost" class="btn">å¤±è”</button>
            </div>
            <div class="assist-row">
                <button id="btnStagePaid" class="btn">å›æ¬¾</button>
            </div>

            <div class="assist-unsigned">
                <div class="unsigned-header">
                    <h4>æœªæ¥30å¤©å®¢æˆ·çœ‹æ¿</h4>
                    <div class="monitor-controls">
                        <button id="btnRefreshUnsigned" class="btn btn-secondary btn-refresh">åˆ·æ–°</button>
                    </div>
                </div>
                <div class="unsigned-body">
                    <div id="status-filter-container" class="filter-container">
                        <!-- çŠ¶æ€ç­›é€‰å™¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div id="unsignedCustomersList" class="unsigned-list">
                        <div class="loading" style="text-align: center; color: #666; padding: 10px;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            <div class="assist-calendar">
                <div class="calendar-display">
                    <div class="calendar-date" id="calendarDate">2025å¹´10æœˆ15æ—¥</div>
                    <div class="calendar-time" id="calendarTime">16:56</div>
                    <div class="calendar-revenue" id="calendarRevenue">æœ¬æœˆæ”¶æ¬¾æ€»é‡‘é¢: <span id="monthlyRevenue">0</span>å…ƒ
                    </div>
                </div>
            </div>

            <input id="assistAsk" class="assist-input" placeholder="é—®ä¸€å¥ï¼ˆå…ˆæœ¬åœ°æ£€ç´¢ï¼Œä¹‹åæ¥å…¥çŸ¥è¯†åº“/è®°å¿†ï¼‰">
            <div class="assist-row">
                <button id="btnAsk" class="btn">é—®</button>
                <button id="btnClear" class="btn btn-secondary">æ¸…ç©º</button>
            </div>
            <div id="assistAnswer" class="assist-help">æç¤ºï¼šç”ŸæˆåˆåŒæˆåŠŸåä¼šè‡ªåŠ¨æ¨è¿›åˆ°"åˆåŒ"ã€‚</div>
        </div>
    </div>
</body>

</html>